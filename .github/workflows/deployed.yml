name: Build

on:
  push:
    branches:
      - main


jobs:
  sonar:
    name: Checkout code and Sonar Scan
    runs-on: self-hosted
    steps:
      # - uses: actions/checkout@v2
      #   with:
      #     fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      # - name: SonarQube Scan
      # - uses: sonarsource/sonarqube-scan-action@master
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      - uses: actions/checkout@v4
        with:
          # Disabling shallow clones is recommended for improving the relevancy of reporting
          fetch-depth: 0
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5.2.0 # Ex: v4.1.0, See the latest version at https://github.com/marketplace/actions/official-sonarqube-scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
  
      - name: SonarQube Quality Gate check
        id: sonarqube-quality-gate-check
        uses: sonarsource/sonarqube-quality-gate-action@master
        with:
           pollingTimeoutSec: 600
        env:
           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
           SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
  
  compile:
    runs-on: self-hosted
    needs: sonar
    
    steps:
    - uses: actions/checkout@v4
    - name: Compile
      run: npm install

  test:
    runs-on: self-hosted
    needs: compile
    
    steps:
    - uses: actions/checkout@v4
    - name: Test 
      run: npm test

  trivy:
    runs-on: self-hosted
    needs: compile
    
    steps:
    - uses: actions/checkout@v4
    - name: Trivy file scan 
      run: trivy fs . > trivyfs.txt





      
